
const dict = {
	"首页": "Home",
	"我的桌面": "My Desktop",
	"公告留言": "Announcements & Messages",
	"已收公告": "Received Announcements",
	"已收留言": "Received Messages",
	"消息通知": "Notifications",
	"个人信息": "Personal Info",
	"修改个人信息": "Edit Personal Info",
	"在线问答": "Online Q&A",
	"我的信息": "My Info",
	"教师信息查看": "Teacher Info",
	"教学周历": "Teaching Calendar",
	"教学周历查询": "Teaching Calendar Query",
	"文档管理": "Document Management",
	"文档内容管理": "Document Content Management",
	"教学服务": "Teaching Services",
	"培养方案": "Training Program",
	"专业培养方案": "Major Training Program",
	"教学计划": "Teaching Plan",
	"通选开课申请": "Elective Course Application",
	"教学任务确认": "Teaching Task Confirmation",
	"我的课表": "My Timetable",
	"个人课表信息": "Personal Timetable",
	"个人调课申请": "Personal Reschedule Application",
	"班级课表查询": "Class Timetable Query",
	"教室课表查询": "Classroom Timetable Query",
	"课程课表查询": "Course Timetable Query",
	"教学安排查询": "Teaching Arrangement Query",
	"免听/免修审核": "Exemption Review",
	"课程信息查询": "Course Info Query",
	"课程信息": "Course Info",
	"教室借用": "Classroom Borrowing",
	"教室借用申请": "Classroom Borrowing Application",
	"教室借用记录": "Classroom Borrowing Records",
	"考务成绩": "Exam & Grades",
	"考试事务": "Exam Affairs",
	"课程考试安排查询": "Course Exam Arrangement Query",
	"考务安排查询": "Exam Arrangement Query",
	"考试信息查询": "Exam Info Query",
	"监考调代申请": "Invigilation Substitute Application",
	"学生成绩": "Student Grades",
	"考勤表": "Attendance Sheet",
	"学生成绩录入": "Student Grade Entry",
	"成绩修改管理": "Grade Modification Management",
	"过程成绩管理": "Process Grade Management",
	"教学考评": "Teaching Evaluation",
	"教学评价": "Teaching Evaluation",
	"评价结果查询": "Evaluation Result Query",
	"工作量查询": "Workload Query",
	"我的评价": "My Evaluation",
	"实践实验": "Practice & Experiment",
	"毕业设计": "Graduation Project",
	"课题申报管理": "Project Application Management",
	"课题修改申请": "Project Modification Application",
	"学生选题处理": "Student Topic Handling",
	"任务书填报": "Task Book Submission",
	"开题报告查看": "Proposal Report View",
	"过程指导情况": "Process Guidance",
	"中期报告填报": "Mid-term Report Submission",
	"成绩录入": "Grade Entry",
	"教育科研": "Education & Research",
	"项目申报管理": "Project Application Management",
	"专家网上评分": "Expert Online Scoring",
	"项目查询": "Project Query",
	"项目材料模板": "Project Material Template",
	"中检专家网上评分": "Mid-term Expert Online Scoring",
	"结题专家网上评分": "Final Expert Online Scoring",
	"个人中心": "Personal Center",
	"教师": "Teacher",
	"修改密码": "Change Password",
	"退出登录": "Logout",
	"请输入菜单名": "Please enter menu name",
	"常用功能": "Common Functions",
	"教学进程": "Teaching Progress",
	"通知公告": "Announcements",
	"审核通知": "Review Notifications",
	"学生评教": "Student Evaluation",
	"学生选课": "Student Course Selection",
	"补考报名": "Make-up Exam Registration",
	"重修报名": "Retake Registration",
	"学生报到": "Student Check-in",
	"学生注册": "Student Registration",
	"星期一": "Monday",
	"星期二": "Tuesday",
	"星期三": "Wednesday",
	"星期四": "Thursday",
	"星期五": "Friday",
	"星期六": "Saturday",
	"星期日": "Sunday",
	"默认节次模式": "Default Session Mode",
	"查询教室借用": "Query Classroom Borrowing",
	"备注": "Remark",
	"账号": "Account",
	"密码": "Password",
	"用户登录": "User Login",
	"登录": "Login",
	"注册": "Register",
	"请输入": "Please enter",
	"忘记密码": "Forgot Password",
	"验证码": "Verification Code",
	"验证码错误": "Verification Code Error",
	"请输入验证码": "Please enter verification code",
	//成绩比例设置
	"序号": "Serial Number",
	"单位名称": "Department Name",
	"专业名称": "Major Name",
	"当前年级": "Current Grade",
	"班级": "Class",
	"学号": "Student ID",
	"姓名": "Name",
	"性别": "Gender",
	"课堂花名册":"Class List",
	"花名册":"Member List",
	"登分册":"Grade List",
	"录入成绩":"Enter Grades",
	"课堂名称":"Class Name",
	"导出":"Export",
	"导 出":"Export", // 添加带空格的版本
	"成绩登分册": "Grade List",
	"按教学班导出": "Export by Teaching Class",
	"按行政班导出": "Export by Administrative Class",
	"取消": "Cancel",
	//过程成绩管理
	"学生过程成绩": "Student Process Grades",
	"课程编号": "Course Number",
	"课程名称": "Course Name",
	"班级名称": "Class Name",
	"分组名称": "Group Name",
	"审核状态": "Review Status",
	"操作":"Operation",
	"页":"page",
	"查看":"View",
	"条":"item",
	"总":"total",
	//期末成绩录入
	"活动名称": "Exam Name",
	"录入开始时间": "Entry Start Time",
	"录入结束时间": "Entry End Time",
	"未查询到数据": "No data found",
	"进入": "Enter",
	"课程列表": "Course List",
	"课程编号": "Course Code",
	"课程名称": "Course Name",
	"审核状态": "Approval Status",
	"-- 请选择 --": "-- Please Select --",
	"查 询": "Search",
	"课程属性": "Course Attribute",
	"开课单位": "Offering Department",
	"班级名称": "Class Name",
	"未录人数/人数": "Unrecorded Count/Total Count",
	"允许分批送审": "Allow Batch Submission for Approval",
	"录入完毕": "Entry Completed",
	"操作": "Action",
	//教学周历查询
	"周次": "Week Number",
	"星期": "Weekday",
	"学年": "Academic Year",
	"第1学期": "1st Semester",
	"第2学期": "2nd Semester",
	"第3学期": "3rd Semester",
	"周历编制": "Weekly Calendar Compilation"
};

const cnNumMap = {
	"一": 1, "二": 2, "三": 3, "四": 4, "五": 5, "六": 6, "七": 7, "八": 8, "九": 9, "十": 10
};

const enWeekMap = {
	1: "One", 2: "Two", 3: "Three", 4: "Four", 5: "Five", 6: "Six", 7: "Seven", 8: "Eight", 9: "Nine", 10: "Ten",
	11: "Eleven", 12: "Twelve", 13: "Thirteen", 14: "Fourteen", 15: "Fifteen", 16: "Sixteen", 17: "Seventeen", 18: "Eighteen", 19: "Nineteen", 20: "Twenty"
};

function weekCnToEn(cn) {
	if (/^\d+$/.test(cn)) return enWeekMap[parseInt(cn)] || cn;
	if (cn === "十") return enWeekMap[10];
	if (cn.length === 2 && cn[0] === "十") return enWeekMap[10 + cnNumMap[cn[1]]];
	if (cn.length === 2 && cn[1] === "十") return enWeekMap[cnNumMap[cn[0]] * 10];
	if (cn.length === 2) return enWeekMap[10 + cnNumMap[cn[1]]];
	return enWeekMap[cnNumMap[cn]] || cn;
}

const regexDict = [
	{
		pattern: /第([一二三四五六七八九十\d]+)周/g,
		replace: (m, p1) => {
			let en = weekCnToEn(p1);
			return `Week ${en}`;
		}
	},
	{ pattern: /学年学期/g, replace: "Academic Year & Term" },
	{ pattern: /我的课程/g, replace: "My Courses" },
];

// 修复iframe路径的函数
function fixIframePaths() {
	const iframes = document.querySelectorAll('iframe');
	iframes.forEach(iframe => {
		const src = iframe.getAttribute('src');
		if (src && src.startsWith('/jsxsd/') && !src.startsWith('/en/jsxsd/')) {
			const newSrc = '/en' + src;
			iframe.setAttribute('src', newSrc);
			console.log(`Fixed iframe src: ${src} -> ${newSrc}`);
		}
	});
}

// 监听DOM变化，修复动态创建的iframe
function observeIframeChanges() {
	const observer = new MutationObserver((mutations) => {
		let iframeAdded = false;
		let buttonAdded = false;
		mutations.forEach((mutation) => {
			mutation.addedNodes.forEach((node) => {
				if (node.nodeType === 1) { // Element node
					if (node.tagName === 'IFRAME') {
						iframeAdded = true;
					} else if (node.tagName === 'INPUT' || node.tagName === 'BUTTON') {
						buttonAdded = true;
					} else if (node.querySelectorAll) {
						const iframes = node.querySelectorAll('iframe');
						if (iframes.length > 0) {
							iframeAdded = true;
						}
						const buttons = node.querySelectorAll('input[type="button"], input[type="submit"], button');
						if (buttons.length > 0) {
							buttonAdded = true;
						}
					}
				}
			});
		});

		if (iframeAdded) {
			setTimeout(fixIframePaths, 400); // 延迟一点确保iframe完全创建
		}
		if (buttonAdded) {
			setTimeout(translateButtons, 400); // 延迟一点确保按钮完全创建
		}
	});

	observer.observe(document.body, {
		childList: true,
		subtree: true
	});
}

function injectEnglishStyle() {
const style = document.createElement('style');
style.innerHTML = `
	body, .edu-container, .edu-main, .edu-aside, .edu-header, .edu-sideMenu, .submenu, .edu-center, .edu-user, .edu-badge, .breadcrumbs, .personal-title, .grid__label {
		font-family: 'Segoe UI', Arial, 'Helvetica Neue', Helvetica, sans-serif !important;
		font-size: 15px !important;
		letter-spacing: 0.02em;
	}
	.edu-sideMenu .submenu li a, .edu-sideMenu .submenu li {
		font-size: 15px !important;
		white-space: nowrap !important;
		overflow: hidden !important;
		text-overflow: ellipsis !important;
		line-height: 1.8 !important;
	}
	.edu-sideMenu .submenu li a b.dot {
		font-size: 12px !important;
	}
	.edu-sideMenu .link, .edu-sideMenu .submenu .link {
		font-size: 16px !important;
	}
	.edu-header .edu-user p, .edu-header .edu-user span {
		font-size: 15px !important;
	}
	.edu-sideMenu .submenu {
		min-width: 180px !important;
	}
	.edu-sideMenu .submenu li {
		position: relative !important;
		height: auto !important;
	}
	.edu-sideMenu .submenu .link {
		display: block !important;
		width: 100% !important;
	}
`;
document.head.appendChild(style);
}

// 智能文本处理函数
function smartTranslateText(text) {
	if (!text || typeof text !== 'string') return text;
	
	let result = text;
	
	// 1. 处理带空格的文本（如"导 出" -> "Export"）
	// 先尝试直接匹配
	if (dict[result]) {
		return dict[result];
	}
	
	// 2. 处理学年学期信息
	// 匹配模式：2024-2025 Academic Year 第 3 学期 Teaching Calendar
	result = result.replace(
		/(\d{4}-\d{4})\s*学年\s*第\s*(\d+)\s*学期\s*教学周历/g,
		(match, year, semester) => {
			const semesterMap = {
				'1': '1st',
				'2': '2nd', 
				'3': '3rd'
			};
			return `${year} Academic Year ${semesterMap[semester] || semester}th Semester Teaching Calendar`;
		}
	);
	
	// 3. 处理单独的学年学期
	result = result.replace(/学年/g, 'Academic Year');
	result = result.replace(/第(\d+)学期/g, (match, num) => {
		const semesterMap = {
			'1': '1st',
			'2': '2nd',
			'3': '3rd'
		};
		return `${semesterMap[num] || num + 'th'} Semester`;
	});
	
	// 4. 处理带空格的词汇
	Object.keys(dict).sort((a, b) => b.length - a.length).forEach(zh => {
		// 创建带空格和不带空格的版本进行匹配
		const patterns = [
			zh,
			zh.replace(/\s+/g, ''), // 移除所有空格
			zh.replace(/(.)/g, '$1 ').trim() // 在每个字符间添加空格
		];
		
		patterns.forEach(pattern => {
			if (result.includes(pattern)) {
				result = result.replace(new RegExp(pattern.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), dict[zh]);
			}
		});
	});
	
	// 5. 应用正则表达式规则
	regexDict.forEach(({pattern, replace}) => {
		result = result.replace(pattern, replace);
	});
	
	return result;
}

function translateTextNode(node) {
if (node.nodeType === 3) {
	let text = node.nodeValue;
	let replaced = smartTranslateText(text);
	if (replaced !== text) node.nodeValue = replaced;
}
}

function translateAttributes(el) {
['placeholder', 'title', 'alt', 'value'].forEach(attr => {
	if (el.hasAttribute && el.hasAttribute(attr)) {
		let val = el.getAttribute(attr);
		if (val) {
			let replaced = val;
			Object.keys(dict).sort((a, b) => b.length - a.length).forEach(zh => {
				if (replaced.includes(zh)) {
					replaced = replaced.split(zh).join(dict[zh]);
				}
			});
			regexDict.forEach(({pattern, replace}) => {
				replaced = replaced.replace(pattern, replace);
			});
			if (replaced !== val) el.setAttribute(attr, replaced);
		}
	}
});
}

function walk(node) {
translateTextNode(node);
if (node.nodeType === 1) {
	translateAttributes(node);
	for (let child of node.childNodes) {
		walk(child);
	}
}
}

function translateIframes() {
let iframes = document.querySelectorAll('iframe');
for (let iframe of iframes) {
	try {
		let doc = iframe.contentDocument || iframe.contentWindow.document;
		if (doc && doc.body) walk(doc.body);
	} catch (e) {}
}
}

// 专门处理按钮翻译的函数
function translateButtons() {
	const buttons = document.querySelectorAll('input[type="button"], input[type="submit"], button');
	buttons.forEach(button => {
		const value = button.getAttribute('value');
		if (value) {
			let replaced = value;
			Object.keys(dict).sort((a, b) => b.length - a.length).forEach(zh => {
				if (replaced.includes(zh)) {
					replaced = replaced.split(zh).join(dict[zh]);
				}
			});
			regexDict.forEach(({pattern, replace}) => {
				replaced = replaced.replace(pattern, replace);
			});
			if (replaced !== value) {
				button.setAttribute('value', replaced);
				console.log(`Fixed button value: ${value} -> ${replaced}`);
			}
		}
		
		// 也处理按钮的文本内容
		if (button.textContent) {
			let replaced = button.textContent;
			Object.keys(dict).sort((a, b) => b.length - a.length).forEach(zh => {
				if (replaced.includes(zh)) {
					replaced = replaced.split(zh).join(dict[zh]);
				}
			});
			regexDict.forEach(({pattern, replace}) => {
				replaced = replaced.replace(pattern, replace);
			});
			if (replaced !== button.textContent) {
				button.textContent = replaced;
			}
		}
	});
}

function observeAndTranslate() {
walk(document.body);
translateIframes();
translateButtons(); // 添加按钮翻译
}

document.addEventListener('DOMContentLoaded', () => {
injectEnglishStyle();
observeAndTranslate();
fixIframePaths(); // 初始修复
translateButtons(); // 初始按钮翻译
observeIframeChanges(); // 开始监听动态变化
});
setInterval(observeAndTranslate, 1000);
setInterval(fixIframePaths, 2000); // 定期检查iframe路径
setInterval(translateButtons, 2000); // 定期检查按钮翻译
